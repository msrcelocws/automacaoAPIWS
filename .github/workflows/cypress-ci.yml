name: PROD - Agrofel - 5.2.3 - Listagem de pedidos por Order - Marketplace

on:
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 11 * * *' # Executa todo dia às 08h (Horário de Brasília - UTC-3)
  workflow_dispatch: # Permite rodar manualmente pelo painel do GitHub

jobs:
  cypress-run:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write      # Necessário para o deploy do Pages
      id-token: write   # Necessário para o deploy do Pages
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: npm install

      - name: Setup Allure History
        uses: actions/cache@v4
        with:
          path: allure-history
          key: ${{ runner.os }}-allure-history-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-allure-history-

      - name: Prepare Allure Results
        run: |
          mkdir -p allure-results/history
          [ -d allure-history ] && cp -r allure-history/* allure-results/history/ || echo "No history found"

      - name: Run Cypress Tests
        run: npm run test:run
        continue-on-error: true
        env:
          CYPRESS_AUTH_USERNAME: ${{ secrets.CYPRESS_AUTH_USERNAME }}
          CYPRESS_AUTH_PASSWORD: ${{ secrets.CYPRESS_AUTH_PASSWORD }}
          CYPRESS_AUTH_BASIC: ${{ secrets.CYPRESS_AUTH_BASIC }}
          GITHUB_RUN_ID: ${{ github.run_id }}

      - name: Generate Allure Report
        run: npx allure generate allure-results --clean -o allure-report

      - name: Customize Allure UI
        run: |
          # 1. Esconde abas indesejadas via CSS
          echo '
          .side-nav__brand { background: #007bff !important; } 
          .side-nav__item[data-tooltip="Graphs"],
          .side-nav__item[data-tooltip="Timeline"],
          .side-nav__item[data-tooltip="Behaviors"],
          .side-nav__item[data-tooltip="Packages"] { display: none !important; }
          ' >> allure-report/styles.css
          
          # 2. Renomeia "Overview" para "HISTÓRICO" via JS (injetando no index.html)
          sed -i 's/<\/body>/<script>setTimeout(() => { document.querySelectorAll(".side-nav__item[data-tooltip=\"Overview\"] .side-nav__label").forEach(el => el.innerText = "HISTÓRICO") }, 1000)<\/script><\/body>/' allure-report/index.html

      - name: Update Allure History
        run: |
          mkdir -p allure-history
          cp -r allure-report/history/* allure-history/

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./allure-report

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Wait for propagation
        if: always()
        run: sleep 35 # Aumentado para 35s para garantir que o CDN do GitHub propague os arquivos

      - name: Slack Notification
        if: always()
        run: node scripts/slack-notify.js ${{ job.status }} ${{ github.run_id }}
        env:
          CYPRESS_SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          CYPRESS_BASE_URL: https://ws.autorei.net
          # A URL do report no GitHub Pages segue o padrão: https://<usuario>.github.io/<repositorio>/
          REPORT_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
