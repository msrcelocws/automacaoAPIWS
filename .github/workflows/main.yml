name: Agrofel - CI/CD Profissional (API)

on:
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 11 * * *' # 08h BrasÃ­lia
  workflow_dispatch:

jobs:
  qa-automation:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: ğŸ“¥ Checkout Projeto
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: ğŸ“¦ Instalar DependÃªncias
        run: npm install

      - name: ğŸ•’ Recuperar HistÃ³rico Allure
        uses: actions/cache@v4
        with:
          path: allure-history
          key: ${{ runner.os }}-allure-history-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-allure-history-

      - name: ğŸ§¹ Preparar Ambiente e Resultados
        run: |
          mkdir -p allure-results/history
          mkdir -p cypress/logs
          [ -d allure-history ] && cp -r allure-history/* allure-results/history/ || echo "Primeira execuÃ§Ã£o: sem histÃ³rico."

      - name: ğŸŒ² Executar Testes Cypress (Especialista)
        id: cypress-run
        run: npm run test:run
        continue-on-error: true
        env:
          # InjeÃ§Ã£o de Secrets (SeguranÃ§a Total)
          CYPRESS_AUTH_USERNAME: ${{ secrets.CYPRESS_AUTH_USERNAME }}
          CYPRESS_AUTH_PASSWORD: ${{ secrets.CYPRESS_AUTH_PASSWORD }}
          CYPRESS_AUTH_BASIC: ${{ secrets.CYPRESS_AUTH_BASIC }}
          CYPRESS_BASE_URL: https://ws.autorei.net
          GITHUB_RUN_ID: ${{ github.run_id }}

      - name: ğŸ“Š Gerar Allure Report Profissional
        run: npx allure generate allure-results --clean -o allure-report

      - name: ğŸ¨ Customizar Interface Allure
        run: |
          # Remove abas nÃ£o utilizadas e renomeia Overview
          echo '
          .side-nav__item[data-tooltip="Graphs"],
          .side-nav__item[data-tooltip="Timeline"],
          .side-nav__item[data-tooltip="Behaviors"] { display: none !important; }
          .side-nav__brand { background: #007bff !important; }
          ' >> allure-report/styles.css
          sed -i 's/<\/body>/<script>setTimeout(() => { document.querySelectorAll(".side-nav__item[data-tooltip=\"Overview\"] .side-nav__label").forEach(el => el.innerText = "HISTÃ“RICO") }, 1000)<\/script><\/body>/' allure-report/index.html

      - name: ğŸ’¾ Salvar Novo HistÃ³rico
        run: |
          mkdir -p allure-history
          cp -r allure-report/history/* allure-history/

      - name: ğŸš€ Publicar no GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./allure-report

      - name: ğŸŒ Deploy
        id: deployment
        uses: actions/deploy-pages@v4

      - name: â³ Wait for propagation
        run: sleep 35

      - name: ğŸ”” NotificaÃ§Ã£o Inteligente (Slack)
        if: always()
        run: node scripts/slack-notify.js ${{ steps.cypress-run.outcome }} ${{ github.run_id }}
        env:
          CYPRESS_SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          CYPRESS_BASE_URL: https://ws.autorei.net
          REPORT_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
